#include <assert.h>
#include <stdlib.h>

#include <unicode/uchar.h>
#include <unicode/unorm2.h>
#include <unicode/utf16.h>

#include <sqlite3ext.h>
SQLITE_EXTENSION_INIT3

/* A smarter version of spellfix1_translit():  Transliterates more
 * characters, including non-BMP ones.  Removes combining characters
 * instead of replacing them with question marks. */

typedef struct Transliteration Transliteration;
struct Transliteration {
  UChar32 cFrom;
  unsigned char cTo0, cTo1, cTo2, cTo3;
};

/*
** Table of translations from unicode characters into ASCII.
*/
static const Transliteration translit[] = {
    {0x00A0, 0x20, 0x00, 0x00, 0x00},  /*   to   */
    {0x00B5, 0x75, 0x00, 0x00, 0x00},  /* ¬µ to u */
    {0x00C0, 0x41, 0x00, 0x00, 0x00},  /* √Ä to A */
    {0x00C1, 0x41, 0x00, 0x00, 0x00},  /* √Å to A */
    {0x00C2, 0x41, 0x00, 0x00, 0x00},  /* √Ç to A */
    {0x00C3, 0x41, 0x00, 0x00, 0x00},  /* √É to A */
    {0x00C4, 0x41, 0x65, 0x00, 0x00},  /* √Ñ to Ae */
    {0x00C5, 0x41, 0x61, 0x00, 0x00},  /* √Ö to Aa */
    {0x00C6, 0x41, 0x45, 0x00, 0x00},  /* √Ü to AE */
    {0x00C7, 0x43, 0x00, 0x00, 0x00},  /* √á to C */
    {0x00C8, 0x45, 0x00, 0x00, 0x00},  /* √à to E */
    {0x00C9, 0x45, 0x00, 0x00, 0x00},  /* √â to E */
    {0x00CA, 0x45, 0x00, 0x00, 0x00},  /* √ä to E */
    {0x00CB, 0x45, 0x00, 0x00, 0x00},  /* √ã to E */
    {0x00CC, 0x49, 0x00, 0x00, 0x00},  /* √å to I */
    {0x00CD, 0x49, 0x00, 0x00, 0x00},  /* √ç to I */
    {0x00CE, 0x49, 0x00, 0x00, 0x00},  /* √é to I */
    {0x00CF, 0x49, 0x00, 0x00, 0x00},  /* √è to I */
    {0x00D0, 0x44, 0x00, 0x00, 0x00},  /* √ê to D */
    {0x00D1, 0x4E, 0x00, 0x00, 0x00},  /* √ë to N */
    {0x00D2, 0x4F, 0x00, 0x00, 0x00},  /* √í to O */
    {0x00D3, 0x4F, 0x00, 0x00, 0x00},  /* √ì to O */
    {0x00D4, 0x4F, 0x00, 0x00, 0x00},  /* √î to O */
    {0x00D5, 0x4F, 0x00, 0x00, 0x00},  /* √ï to O */
    {0x00D6, 0x4F, 0x65, 0x00, 0x00},  /* √ñ to Oe */
    {0x00D7, 0x78, 0x00, 0x00, 0x00},  /* √ó to x */
    {0x00D8, 0x4F, 0x00, 0x00, 0x00},  /* √ò to O */
    {0x00D9, 0x55, 0x00, 0x00, 0x00},  /* √ô to U */
    {0x00DA, 0x55, 0x00, 0x00, 0x00},  /* √ö to U */
    {0x00DB, 0x55, 0x00, 0x00, 0x00},  /* √õ to U */
    {0x00DC, 0x55, 0x65, 0x00, 0x00},  /* √ú to Ue */
    {0x00DD, 0x59, 0x00, 0x00, 0x00},  /* √ù to Y */
    {0x00DE, 0x54, 0x68, 0x00, 0x00},  /* √û to Th */
    {0x00DF, 0x73, 0x73, 0x00, 0x00},  /* √ü to ss */
    {0x00E0, 0x61, 0x00, 0x00, 0x00},  /* √† to a */
    {0x00E1, 0x61, 0x00, 0x00, 0x00},  /* √° to a */
    {0x00E2, 0x61, 0x00, 0x00, 0x00},  /* √¢ to a */
    {0x00E3, 0x61, 0x00, 0x00, 0x00},  /* √£ to a */
    {0x00E4, 0x61, 0x65, 0x00, 0x00},  /* √§ to ae */
    {0x00E5, 0x61, 0x61, 0x00, 0x00},  /* √• to aa */
    {0x00E6, 0x61, 0x65, 0x00, 0x00},  /* √¶ to ae */
    {0x00E7, 0x63, 0x00, 0x00, 0x00},  /* √ß to c */
    {0x00E8, 0x65, 0x00, 0x00, 0x00},  /* √® to e */
    {0x00E9, 0x65, 0x00, 0x00, 0x00},  /* √© to e */
    {0x00EA, 0x65, 0x00, 0x00, 0x00},  /* √™ to e */
    {0x00EB, 0x65, 0x00, 0x00, 0x00},  /* √´ to e */
    {0x00EC, 0x69, 0x00, 0x00, 0x00},  /* √¨ to i */
    {0x00ED, 0x69, 0x00, 0x00, 0x00},  /* √≠ to i */
    {0x00EE, 0x69, 0x00, 0x00, 0x00},  /* √Æ to i */
    {0x00EF, 0x69, 0x00, 0x00, 0x00},  /* √Ø to i */
    {0x00F0, 0x64, 0x00, 0x00, 0x00},  /* √∞ to d */
    {0x00F1, 0x6E, 0x00, 0x00, 0x00},  /* √± to n */
    {0x00F2, 0x6F, 0x00, 0x00, 0x00},  /* √≤ to o */
    {0x00F3, 0x6F, 0x00, 0x00, 0x00},  /* √≥ to o */
    {0x00F4, 0x6F, 0x00, 0x00, 0x00},  /* √¥ to o */
    {0x00F5, 0x6F, 0x00, 0x00, 0x00},  /* √µ to o */
    {0x00F6, 0x6F, 0x65, 0x00, 0x00},  /* √∂ to oe */
    {0x00F7, 0x3A, 0x00, 0x00, 0x00},  /* √∑ to : */
    {0x00F8, 0x6F, 0x00, 0x00, 0x00},  /* √∏ to o */
    {0x00F9, 0x75, 0x00, 0x00, 0x00},  /* √π to u */
    {0x00FA, 0x75, 0x00, 0x00, 0x00},  /* √∫ to u */
    {0x00FB, 0x75, 0x00, 0x00, 0x00},  /* √ª to u */
    {0x00FC, 0x75, 0x65, 0x00, 0x00},  /* √º to ue */
    {0x00FD, 0x79, 0x00, 0x00, 0x00},  /* √Ω to y */
    {0x00FE, 0x74, 0x68, 0x00, 0x00},  /* √æ to th */
    {0x00FF, 0x79, 0x00, 0x00, 0x00},  /* √ø to y */
    {0x0100, 0x41, 0x00, 0x00, 0x00},  /* ƒÄ to A */
    {0x0101, 0x61, 0x00, 0x00, 0x00},  /* ƒÅ to a */
    {0x0102, 0x41, 0x00, 0x00, 0x00},  /* ƒÇ to A */
    {0x0103, 0x61, 0x00, 0x00, 0x00},  /* ƒÉ to a */
    {0x0104, 0x41, 0x00, 0x00, 0x00},  /* ƒÑ to A */
    {0x0105, 0x61, 0x00, 0x00, 0x00},  /* ƒÖ to a */
    {0x0106, 0x43, 0x00, 0x00, 0x00},  /* ƒÜ to C */
    {0x0107, 0x63, 0x00, 0x00, 0x00},  /* ƒá to c */
    {0x0108, 0x43, 0x68, 0x00, 0x00},  /* ƒà to Ch */
    {0x0109, 0x63, 0x68, 0x00, 0x00},  /* ƒâ to ch */
    {0x010A, 0x43, 0x00, 0x00, 0x00},  /* ƒä to C */
    {0x010B, 0x63, 0x00, 0x00, 0x00},  /* ƒã to c */
    {0x010C, 0x43, 0x00, 0x00, 0x00},  /* ƒå to C */
    {0x010D, 0x63, 0x00, 0x00, 0x00},  /* ƒç to c */
    {0x010E, 0x44, 0x00, 0x00, 0x00},  /* ƒé to D */
    {0x010F, 0x64, 0x00, 0x00, 0x00},  /* ƒè to d */
    {0x0110, 0x44, 0x00, 0x00, 0x00},  /* ƒê to D */
    {0x0111, 0x64, 0x00, 0x00, 0x00},  /* ƒë to d */
    {0x0112, 0x45, 0x00, 0x00, 0x00},  /* ƒí to E */
    {0x0113, 0x65, 0x00, 0x00, 0x00},  /* ƒì to e */
    {0x0114, 0x45, 0x00, 0x00, 0x00},  /* ƒî to E */
    {0x0115, 0x65, 0x00, 0x00, 0x00},  /* ƒï to e */
    {0x0116, 0x45, 0x00, 0x00, 0x00},  /* ƒñ to E */
    {0x0117, 0x65, 0x00, 0x00, 0x00},  /* ƒó to e */
    {0x0118, 0x45, 0x00, 0x00, 0x00},  /* ƒò to E */
    {0x0119, 0x65, 0x00, 0x00, 0x00},  /* ƒô to e */
    {0x011A, 0x45, 0x00, 0x00, 0x00},  /* ƒö to E */
    {0x011B, 0x65, 0x00, 0x00, 0x00},  /* ƒõ to e */
    {0x011C, 0x47, 0x68, 0x00, 0x00},  /* ƒú to Gh */
    {0x011D, 0x67, 0x68, 0x00, 0x00},  /* ƒù to gh */
    {0x011E, 0x47, 0x00, 0x00, 0x00},  /* ƒû to G */
    {0x011F, 0x67, 0x00, 0x00, 0x00},  /* ƒü to g */
    {0x0120, 0x47, 0x00, 0x00, 0x00},  /* ƒ† to G */
    {0x0121, 0x67, 0x00, 0x00, 0x00},  /* ƒ° to g */
    {0x0122, 0x47, 0x00, 0x00, 0x00},  /* ƒ¢ to G */
    {0x0123, 0x67, 0x00, 0x00, 0x00},  /* ƒ£ to g */
    {0x0124, 0x48, 0x68, 0x00, 0x00},  /* ƒ§ to Hh */
    {0x0125, 0x68, 0x68, 0x00, 0x00},  /* ƒ• to hh */
    {0x0126, 0x48, 0x00, 0x00, 0x00},  /* ƒ¶ to H */
    {0x0127, 0x68, 0x00, 0x00, 0x00},  /* ƒß to h */
    {0x0128, 0x49, 0x00, 0x00, 0x00},  /* ƒ® to I */
    {0x0129, 0x69, 0x00, 0x00, 0x00},  /* ƒ© to i */
    {0x012A, 0x49, 0x00, 0x00, 0x00},  /* ƒ™ to I */
    {0x012B, 0x69, 0x00, 0x00, 0x00},  /* ƒ´ to i */
    {0x012C, 0x49, 0x00, 0x00, 0x00},  /* ƒ¨ to I */
    {0x012D, 0x69, 0x00, 0x00, 0x00},  /* ƒ≠ to i */
    {0x012E, 0x49, 0x00, 0x00, 0x00},  /* ƒÆ to I */
    {0x012F, 0x69, 0x00, 0x00, 0x00},  /* ƒØ to i */
    {0x0130, 0x49, 0x00, 0x00, 0x00},  /* ƒ∞ to I */
    {0x0131, 0x69, 0x00, 0x00, 0x00},  /* ƒ± to i */
    {0x0132, 0x49, 0x4A, 0x00, 0x00},  /* ƒ≤ to IJ */
    {0x0133, 0x69, 0x6A, 0x00, 0x00},  /* ƒ≥ to ij */
    {0x0134, 0x4A, 0x68, 0x00, 0x00},  /* ƒ¥ to Jh */
    {0x0135, 0x6A, 0x68, 0x00, 0x00},  /* ƒµ to jh */
    {0x0136, 0x4B, 0x00, 0x00, 0x00},  /* ƒ∂ to K */
    {0x0137, 0x6B, 0x00, 0x00, 0x00},  /* ƒ∑ to k */
    {0x0138, 0x6B, 0x00, 0x00, 0x00},  /* ƒ∏ to k */
    {0x0139, 0x4C, 0x00, 0x00, 0x00},  /* ƒπ to L */
    {0x013A, 0x6C, 0x00, 0x00, 0x00},  /* ƒ∫ to l */
    {0x013B, 0x4C, 0x00, 0x00, 0x00},  /* ƒª to L */
    {0x013C, 0x6C, 0x00, 0x00, 0x00},  /* ƒº to l */
    {0x013D, 0x4C, 0x00, 0x00, 0x00},  /* ƒΩ to L */
    {0x013E, 0x6C, 0x00, 0x00, 0x00},  /* ƒæ to l */
    {0x013F, 0x4C, 0x2E, 0x00, 0x00},  /* ƒø to L. */
    {0x0140, 0x6C, 0x2E, 0x00, 0x00},  /* ≈Ä to l. */
    {0x0141, 0x4C, 0x00, 0x00, 0x00},  /* ≈Å to L */
    {0x0142, 0x6C, 0x00, 0x00, 0x00},  /* ≈Ç to l */
    {0x0143, 0x4E, 0x00, 0x00, 0x00},  /* ≈É to N */
    {0x0144, 0x6E, 0x00, 0x00, 0x00},  /* ≈Ñ to n */
    {0x0145, 0x4E, 0x00, 0x00, 0x00},  /* ≈Ö to N */
    {0x0146, 0x6E, 0x00, 0x00, 0x00},  /* ≈Ü to n */
    {0x0147, 0x4E, 0x00, 0x00, 0x00},  /* ≈á to N */
    {0x0148, 0x6E, 0x00, 0x00, 0x00},  /* ≈à to n */
    {0x0149, 0x27, 0x6E, 0x00, 0x00},  /* ≈â to 'n */
    {0x014A, 0x4E, 0x47, 0x00, 0x00},  /* ≈ä to NG */
    {0x014B, 0x6E, 0x67, 0x00, 0x00},  /* ≈ã to ng */
    {0x014C, 0x4F, 0x00, 0x00, 0x00},  /* ≈å to O */
    {0x014D, 0x6F, 0x00, 0x00, 0x00},  /* ≈ç to o */
    {0x014E, 0x4F, 0x00, 0x00, 0x00},  /* ≈é to O */
    {0x014F, 0x6F, 0x00, 0x00, 0x00},  /* ≈è to o */
    {0x0150, 0x4F, 0x00, 0x00, 0x00},  /* ≈ê to O */
    {0x0151, 0x6F, 0x00, 0x00, 0x00},  /* ≈ë to o */
    {0x0152, 0x4F, 0x45, 0x00, 0x00},  /* ≈í to OE */
    {0x0153, 0x6F, 0x65, 0x00, 0x00},  /* ≈ì to oe */
    {0x0154, 0x52, 0x00, 0x00, 0x00},  /* ≈î to R */
    {0x0155, 0x72, 0x00, 0x00, 0x00},  /* ≈ï to r */
    {0x0156, 0x52, 0x00, 0x00, 0x00},  /* ≈ñ to R */
    {0x0157, 0x72, 0x00, 0x00, 0x00},  /* ≈ó to r */
    {0x0158, 0x52, 0x00, 0x00, 0x00},  /* ≈ò to R */
    {0x0159, 0x72, 0x00, 0x00, 0x00},  /* ≈ô to r */
    {0x015A, 0x53, 0x00, 0x00, 0x00},  /* ≈ö to S */
    {0x015B, 0x73, 0x00, 0x00, 0x00},  /* ≈õ to s */
    {0x015C, 0x53, 0x68, 0x00, 0x00},  /* ≈ú to Sh */
    {0x015D, 0x73, 0x68, 0x00, 0x00},  /* ≈ù to sh */
    {0x015E, 0x53, 0x00, 0x00, 0x00},  /* ≈û to S */
    {0x015F, 0x73, 0x00, 0x00, 0x00},  /* ≈ü to s */
    {0x0160, 0x53, 0x00, 0x00, 0x00},  /* ≈† to S */
    {0x0161, 0x73, 0x00, 0x00, 0x00},  /* ≈° to s */
    {0x0162, 0x54, 0x00, 0x00, 0x00},  /* ≈¢ to T */
    {0x0163, 0x74, 0x00, 0x00, 0x00},  /* ≈£ to t */
    {0x0164, 0x54, 0x00, 0x00, 0x00},  /* ≈§ to T */
    {0x0165, 0x74, 0x00, 0x00, 0x00},  /* ≈• to t */
    {0x0166, 0x54, 0x00, 0x00, 0x00},  /* ≈¶ to T */
    {0x0167, 0x74, 0x00, 0x00, 0x00},  /* ≈ß to t */
    {0x0168, 0x55, 0x00, 0x00, 0x00},  /* ≈® to U */
    {0x0169, 0x75, 0x00, 0x00, 0x00},  /* ≈© to u */
    {0x016A, 0x55, 0x00, 0x00, 0x00},  /* ≈™ to U */
    {0x016B, 0x75, 0x00, 0x00, 0x00},  /* ≈´ to u */
    {0x016C, 0x55, 0x00, 0x00, 0x00},  /* ≈¨ to U */
    {0x016D, 0x75, 0x00, 0x00, 0x00},  /* ≈≠ to u */
    {0x016E, 0x55, 0x00, 0x00, 0x00},  /* ≈Æ to U */
    {0x016F, 0x75, 0x00, 0x00, 0x00},  /* ≈Ø to u */
    {0x0170, 0x55, 0x00, 0x00, 0x00},  /* ≈∞ to U */
    {0x0171, 0x75, 0x00, 0x00, 0x00},  /* ≈± to u */
    {0x0172, 0x55, 0x00, 0x00, 0x00},  /* ≈≤ to U */
    {0x0173, 0x75, 0x00, 0x00, 0x00},  /* ≈≥ to u */
    {0x0174, 0x57, 0x00, 0x00, 0x00},  /* ≈¥ to W */
    {0x0175, 0x77, 0x00, 0x00, 0x00},  /* ≈µ to w */
    {0x0176, 0x59, 0x00, 0x00, 0x00},  /* ≈∂ to Y */
    {0x0177, 0x79, 0x00, 0x00, 0x00},  /* ≈∑ to y */
    {0x0178, 0x59, 0x00, 0x00, 0x00},  /* ≈∏ to Y */
    {0x0179, 0x5A, 0x00, 0x00, 0x00},  /* ≈π to Z */
    {0x017A, 0x7A, 0x00, 0x00, 0x00},  /* ≈∫ to z */
    {0x017B, 0x5A, 0x00, 0x00, 0x00},  /* ≈ª to Z */
    {0x017C, 0x7A, 0x00, 0x00, 0x00},  /* ≈º to z */
    {0x017D, 0x5A, 0x00, 0x00, 0x00},  /* ≈Ω to Z */
    {0x017E, 0x7A, 0x00, 0x00, 0x00},  /* ≈æ to z */
    {0x017F, 0x73, 0x00, 0x00, 0x00},  /* ≈ø to s */
    {0x0192, 0x66, 0x00, 0x00, 0x00},  /* ∆í to f */
    {0x0218, 0x53, 0x00, 0x00, 0x00},  /* »ò to S */
    {0x0219, 0x73, 0x00, 0x00, 0x00},  /* »ô to s */
    {0x021A, 0x54, 0x00, 0x00, 0x00},  /* »ö to T */
    {0x021B, 0x74, 0x00, 0x00, 0x00},  /* »õ to t */
    {0x0386, 0x41, 0x00, 0x00, 0x00},  /* ŒÜ to A */
    {0x0388, 0x45, 0x00, 0x00, 0x00},  /* Œà to E */
    {0x0389, 0x49, 0x00, 0x00, 0x00},  /* Œâ to I */
    {0x038A, 0x49, 0x00, 0x00, 0x00},  /* Œä to I */
    {0x038C, 0x4f, 0x00, 0x00, 0x00},  /* Œå to O */
    {0x038E, 0x59, 0x00, 0x00, 0x00},  /* Œé to Y */
    {0x038F, 0x4f, 0x00, 0x00, 0x00},  /* Œè to O */
    {0x0390, 0x69, 0x00, 0x00, 0x00},  /* Œê to i */
    {0x0391, 0x41, 0x00, 0x00, 0x00},  /* Œë to A */
    {0x0392, 0x42, 0x00, 0x00, 0x00},  /* Œí to B */
    {0x0393, 0x47, 0x00, 0x00, 0x00},  /* Œì to G */
    {0x0394, 0x44, 0x00, 0x00, 0x00},  /* Œî to D */
    {0x0395, 0x45, 0x00, 0x00, 0x00},  /* Œï to E */
    {0x0396, 0x5a, 0x00, 0x00, 0x00},  /* Œñ to Z */
    {0x0397, 0x49, 0x00, 0x00, 0x00},  /* Œó to I */
    {0x0398, 0x54, 0x68, 0x00, 0x00},  /* Œò to Th */
    {0x0399, 0x49, 0x00, 0x00, 0x00},  /* Œô to I */
    {0x039A, 0x4b, 0x00, 0x00, 0x00},  /* Œö to K */
    {0x039B, 0x4c, 0x00, 0x00, 0x00},  /* Œõ to L */
    {0x039C, 0x4d, 0x00, 0x00, 0x00},  /* Œú to M */
    {0x039D, 0x4e, 0x00, 0x00, 0x00},  /* Œù to N */
    {0x039E, 0x58, 0x00, 0x00, 0x00},  /* Œû to X */
    {0x039F, 0x4f, 0x00, 0x00, 0x00},  /* Œü to O */
    {0x03A0, 0x50, 0x00, 0x00, 0x00},  /* Œ† to P */
    {0x03A1, 0x52, 0x00, 0x00, 0x00},  /* Œ° to R */
    {0x03A3, 0x53, 0x00, 0x00, 0x00},  /* Œ£ to S */
    {0x03A4, 0x54, 0x00, 0x00, 0x00},  /* Œ§ to T */
    {0x03A5, 0x59, 0x00, 0x00, 0x00},  /* Œ• to Y */
    {0x03A6, 0x46, 0x00, 0x00, 0x00},  /* Œ¶ to F */
    {0x03A7, 0x43, 0x68, 0x00, 0x00},  /* Œß to Ch */
    {0x03A8, 0x50, 0x73, 0x00, 0x00},  /* Œ® to Ps */
    {0x03A9, 0x4f, 0x00, 0x00, 0x00},  /* Œ© to O */
    {0x03AA, 0x49, 0x00, 0x00, 0x00},  /* Œ™ to I */
    {0x03AB, 0x59, 0x00, 0x00, 0x00},  /* Œ´ to Y */
    {0x03AC, 0x61, 0x00, 0x00, 0x00},  /* Œ¨ to a */
    {0x03AD, 0x65, 0x00, 0x00, 0x00},  /* Œ≠ to e */
    {0x03AE, 0x69, 0x00, 0x00, 0x00},  /* ŒÆ to i */
    {0x03AF, 0x69, 0x00, 0x00, 0x00},  /* ŒØ to i */
    {0x03B1, 0x61, 0x00, 0x00, 0x00},  /* Œ± to a */
    {0x03B2, 0x62, 0x00, 0x00, 0x00},  /* Œ≤ to b */
    {0x03B3, 0x67, 0x00, 0x00, 0x00},  /* Œ≥ to g */
    {0x03B4, 0x64, 0x00, 0x00, 0x00},  /* Œ¥ to d */
    {0x03B5, 0x65, 0x00, 0x00, 0x00},  /* Œµ to e */
    {0x03B6, 0x7a, 0x00, 0x00, 0x00},  /* Œ∂ to z */
    {0x03B7, 0x69, 0x00, 0x00, 0x00},  /* Œ∑ to i */
    {0x03B8, 0x74, 0x68, 0x00, 0x00},  /* Œ∏ to th */
    {0x03B9, 0x69, 0x00, 0x00, 0x00},  /* Œπ to i */
    {0x03BA, 0x6b, 0x00, 0x00, 0x00},  /* Œ∫ to k */
    {0x03BB, 0x6c, 0x00, 0x00, 0x00},  /* Œª to l */
    {0x03BC, 0x6d, 0x00, 0x00, 0x00},  /* Œº to m */
    {0x03BD, 0x6e, 0x00, 0x00, 0x00},  /* ŒΩ to n */
    {0x03BE, 0x78, 0x00, 0x00, 0x00},  /* Œæ to x */
    {0x03BF, 0x6f, 0x00, 0x00, 0x00},  /* Œø to o */
    {0x03C0, 0x70, 0x00, 0x00, 0x00},  /* œÄ to p */
    {0x03C1, 0x72, 0x00, 0x00, 0x00},  /* œÅ to r */
    {0x03C3, 0x73, 0x00, 0x00, 0x00},  /* œÉ to s */
    {0x03C4, 0x74, 0x00, 0x00, 0x00},  /* œÑ to t */
    {0x03C5, 0x79, 0x00, 0x00, 0x00},  /* œÖ to y */
    {0x03C6, 0x66, 0x00, 0x00, 0x00},  /* œÜ to f */
    {0x03C7, 0x63, 0x68, 0x00, 0x00},  /* œá to ch */
    {0x03C8, 0x70, 0x73, 0x00, 0x00},  /* œà to ps */
    {0x03C9, 0x6f, 0x00, 0x00, 0x00},  /* œâ to o */
    {0x03CA, 0x69, 0x00, 0x00, 0x00},  /* œä to i */
    {0x03CB, 0x79, 0x00, 0x00, 0x00},  /* œã to y */
    {0x03CC, 0x6f, 0x00, 0x00, 0x00},  /* œå to o */
    {0x03CD, 0x79, 0x00, 0x00, 0x00},  /* œç to y */
    {0x03CE, 0x69, 0x00, 0x00, 0x00},  /* œé to i */
    {0x0400, 0x45, 0x00, 0x00, 0x00},  /* –Ä to E */
    {0x0401, 0x45, 0x00, 0x00, 0x00},  /* –Å to E */
    {0x0402, 0x44, 0x00, 0x00, 0x00},  /* –Ç to D */
    {0x0403, 0x47, 0x00, 0x00, 0x00},  /* –É to G */
    {0x0404, 0x45, 0x00, 0x00, 0x00},  /* –Ñ to E */
    {0x0405, 0x5a, 0x00, 0x00, 0x00},  /* –Ö to Z */
    {0x0406, 0x49, 0x00, 0x00, 0x00},  /* –Ü to I */
    {0x0407, 0x49, 0x00, 0x00, 0x00},  /* –á to I */
    {0x0408, 0x4a, 0x00, 0x00, 0x00},  /* –à to J */
    {0x0409, 0x49, 0x00, 0x00, 0x00},  /* –â to I */
    {0x040A, 0x4e, 0x00, 0x00, 0x00},  /* –ä to N */
    {0x040B, 0x44, 0x00, 0x00, 0x00},  /* –ã to D */
    {0x040C, 0x4b, 0x00, 0x00, 0x00},  /* –å to K */
    {0x040D, 0x49, 0x00, 0x00, 0x00},  /* –ç to I */
    {0x040E, 0x55, 0x00, 0x00, 0x00},  /* –é to U */
    {0x040F, 0x44, 0x00, 0x00, 0x00},  /* –è to D */
    {0x0410, 0x41, 0x00, 0x00, 0x00},  /* –ê to A */
    {0x0411, 0x42, 0x00, 0x00, 0x00},  /* –ë to B */
    {0x0412, 0x56, 0x00, 0x00, 0x00},  /* –í to V */
    {0x0413, 0x47, 0x00, 0x00, 0x00},  /* –ì to G */
    {0x0414, 0x44, 0x00, 0x00, 0x00},  /* –î to D */
    {0x0415, 0x45, 0x00, 0x00, 0x00},  /* –ï to E */
    {0x0416, 0x5a, 0x68, 0x00, 0x00},  /* –ñ to Zh */
    {0x0417, 0x5a, 0x00, 0x00, 0x00},  /* –ó to Z */
    {0x0418, 0x49, 0x00, 0x00, 0x00},  /* –ò to I */
    {0x0419, 0x49, 0x00, 0x00, 0x00},  /* –ô to I */
    {0x041A, 0x4b, 0x00, 0x00, 0x00},  /* –ö to K */
    {0x041B, 0x4c, 0x00, 0x00, 0x00},  /* –õ to L */
    {0x041C, 0x4d, 0x00, 0x00, 0x00},  /* –ú to M */
    {0x041D, 0x4e, 0x00, 0x00, 0x00},  /* –ù to N */
    {0x041E, 0x4f, 0x00, 0x00, 0x00},  /* –û to O */
    {0x041F, 0x50, 0x00, 0x00, 0x00},  /* –ü to P */
    {0x0420, 0x52, 0x00, 0x00, 0x00},  /* –† to R */
    {0x0421, 0x53, 0x00, 0x00, 0x00},  /* –° to S */
    {0x0422, 0x54, 0x00, 0x00, 0x00},  /* –¢ to T */
    {0x0423, 0x55, 0x00, 0x00, 0x00},  /* –£ to U */
    {0x0424, 0x46, 0x00, 0x00, 0x00},  /* –§ to F */
    {0x0425, 0x4b, 0x68, 0x00, 0x00},  /* –• to Kh */
    {0x0426, 0x54, 0x63, 0x00, 0x00},  /* –¶ to Tc */
    {0x0427, 0x43, 0x68, 0x00, 0x00},  /* –ß to Ch */
    {0x0428, 0x53, 0x68, 0x00, 0x00},  /* –® to Sh */
    {0x0429, 0x53, 0x68, 0x63, 0x68},  /* –© to Shch */
    {0x042A, 0x61, 0x00, 0x00, 0x00},  /*  to A */
    {0x042B, 0x59, 0x00, 0x00, 0x00},  /* –´ to Y */
    {0x042C, 0x59, 0x00, 0x00, 0x00},  /*  to Y */
    {0x042D, 0x45, 0x00, 0x00, 0x00},  /* –≠ to E */
    {0x042E, 0x49, 0x75, 0x00, 0x00},  /* –Æ to Iu */
    {0x042F, 0x49, 0x61, 0x00, 0x00},  /* –Ø to Ia */
    {0x0430, 0x61, 0x00, 0x00, 0x00},  /* –∞ to a */
    {0x0431, 0x62, 0x00, 0x00, 0x00},  /* –± to b */
    {0x0432, 0x76, 0x00, 0x00, 0x00},  /* –≤ to v */
    {0x0433, 0x67, 0x00, 0x00, 0x00},  /* –≥ to g */
    {0x0434, 0x64, 0x00, 0x00, 0x00},  /* –¥ to d */
    {0x0435, 0x65, 0x00, 0x00, 0x00},  /* –µ to e */
    {0x0436, 0x7a, 0x68, 0x00, 0x00},  /* –∂ to zh */
    {0x0437, 0x7a, 0x00, 0x00, 0x00},  /* –∑ to z */
    {0x0438, 0x69, 0x00, 0x00, 0x00},  /* –∏ to i */
    {0x0439, 0x69, 0x00, 0x00, 0x00},  /* –π to i */
    {0x043A, 0x6b, 0x00, 0x00, 0x00},  /* –∫ to k */
    {0x043B, 0x6c, 0x00, 0x00, 0x00},  /* –ª to l */
    {0x043C, 0x6d, 0x00, 0x00, 0x00},  /* –º to m */
    {0x043D, 0x6e, 0x00, 0x00, 0x00},  /* –Ω to n */
    {0x043E, 0x6f, 0x00, 0x00, 0x00},  /* –æ to o */
    {0x043F, 0x70, 0x00, 0x00, 0x00},  /* –ø to p */
    {0x0440, 0x72, 0x00, 0x00, 0x00},  /* —Ä to r */
    {0x0441, 0x73, 0x00, 0x00, 0x00},  /* —Å to s */
    {0x0442, 0x74, 0x00, 0x00, 0x00},  /* —Ç to t */
    {0x0443, 0x75, 0x00, 0x00, 0x00},  /* —É to u */
    {0x0444, 0x66, 0x00, 0x00, 0x00},  /* —Ñ to f */
    {0x0445, 0x6b, 0x68, 0x00, 0x00},  /* —Ö to kh */
    {0x0446, 0x74, 0x63, 0x00, 0x00},  /* —Ü to tc */
    {0x0447, 0x63, 0x68, 0x00, 0x00},  /* —á to ch */
    {0x0448, 0x73, 0x68, 0x00, 0x00},  /* —à to sh */
    {0x0449, 0x73, 0x68, 0x63, 0x68},  /* —â to shch */
    {0x044A, 0x61, 0x00, 0x00, 0x00},  /*  to a */
    {0x044B, 0x79, 0x00, 0x00, 0x00},  /* —ã to y */
    {0x044C, 0x79, 0x00, 0x00, 0x00},  /*  to y */
    {0x044D, 0x65, 0x00, 0x00, 0x00},  /* —ç to e */
    {0x044E, 0x69, 0x75, 0x00, 0x00},  /* —é to iu */
    {0x044F, 0x69, 0x61, 0x00, 0x00},  /* —è to ia */
    {0x0450, 0x65, 0x00, 0x00, 0x00},  /* —ê to e */
    {0x0451, 0x65, 0x00, 0x00, 0x00},  /* —ë to e */
    {0x0452, 0x64, 0x00, 0x00, 0x00},  /* —í to d */
    {0x0453, 0x67, 0x00, 0x00, 0x00},  /* —ì to g */
    {0x0454, 0x65, 0x00, 0x00, 0x00},  /* —î to e */
    {0x0455, 0x7a, 0x00, 0x00, 0x00},  /* —ï to z */
    {0x0456, 0x69, 0x00, 0x00, 0x00},  /* —ñ to i */
    {0x0457, 0x69, 0x00, 0x00, 0x00},  /* —ó to i */
    {0x0458, 0x6a, 0x00, 0x00, 0x00},  /* —ò to j */
    {0x0459, 0x69, 0x00, 0x00, 0x00},  /* —ô to i */
    {0x045A, 0x6e, 0x00, 0x00, 0x00},  /* —ö to n */
    {0x045B, 0x64, 0x00, 0x00, 0x00},  /* —õ to d */
    {0x045C, 0x6b, 0x00, 0x00, 0x00},  /* —ú to k */
    {0x045D, 0x69, 0x00, 0x00, 0x00},  /* —ù to i */
    {0x045E, 0x75, 0x00, 0x00, 0x00},  /* —û to u */
    {0x045F, 0x64, 0x00, 0x00, 0x00},  /* —ü to d */
    {0x1D6B, 0x75, 0x65, 0x00, 0x00},  /* ·µ´ to ue */
    {0x1E02, 0x42, 0x00, 0x00, 0x00},  /* ·∏Ç to B */
    {0x1E03, 0x62, 0x00, 0x00, 0x00},  /* ·∏É to b */
    {0x1E0A, 0x44, 0x00, 0x00, 0x00},  /* ·∏ä to D */
    {0x1E0B, 0x64, 0x00, 0x00, 0x00},  /* ·∏ã to d */
    {0x1E1E, 0x46, 0x00, 0x00, 0x00},  /* ·∏û to F */
    {0x1E1F, 0x66, 0x00, 0x00, 0x00},  /* ·∏ü to f */
    {0x1E40, 0x4D, 0x00, 0x00, 0x00},  /* ·πÄ to M */
    {0x1E41, 0x6D, 0x00, 0x00, 0x00},  /* ·πÅ to m */
    {0x1E56, 0x50, 0x00, 0x00, 0x00},  /* ·πñ to P */
    {0x1E57, 0x70, 0x00, 0x00, 0x00},  /* ·πó to p */
    {0x1E60, 0x53, 0x00, 0x00, 0x00},  /* ·π† to S */
    {0x1E61, 0x73, 0x00, 0x00, 0x00},  /* ·π° to s */
    {0x1E6A, 0x54, 0x00, 0x00, 0x00},  /* ·π™ to T */
    {0x1E6B, 0x74, 0x00, 0x00, 0x00},  /* ·π´ to t */
    {0x1E80, 0x57, 0x00, 0x00, 0x00},  /* ·∫Ä to W */
    {0x1E81, 0x77, 0x00, 0x00, 0x00},  /* ·∫Å to w */
    {0x1E82, 0x57, 0x00, 0x00, 0x00},  /* ·∫Ç to W */
    {0x1E83, 0x77, 0x00, 0x00, 0x00},  /* ·∫É to w */
    {0x1E84, 0x57, 0x00, 0x00, 0x00},  /* ·∫Ñ to W */
    {0x1E85, 0x77, 0x00, 0x00, 0x00},  /* ·∫Ö to w */
    {0x1EF2, 0x59, 0x00, 0x00, 0x00},  /* ·ª≤ to Y */
    {0x1EF3, 0x79, 0x00, 0x00, 0x00},  /* ·ª≥ to y */
    {0x2010, 0x2D, 0x00, 0x00, 0x00},  /* ‚Äê to - */
    {0x2011, 0x2D, 0x00, 0x00, 0x00},  /* ‚Äë to - */
    {0x2012, 0x2D, 0x2D, 0x00, 0x00},  /* ‚Äí to -- */
    {0x2013, 0x2D, 0x2D, 0x00, 0x00},  /* ‚Äì to -- */
    {0x2014, 0x2D, 0x2D, 0x2D, 0x00},  /* ‚Äî to --- */
    {0x2015, 0x2D, 0x2D, 0x2D, 0x00},  /* ‚Äï to --- */
    {0x2018, 0x27, 0x00, 0x00, 0x00},  /* ‚Äò to ' */
    {0x2019, 0x27, 0x00, 0x00, 0x00},  /* ‚Äô to ' */
    {0x201A, 0x27, 0x00, 0x00, 0x00},  /* ‚Äö to ' */
    {0x201B, 0x27, 0x00, 0x00, 0x00},  /* ‚Äõ to ' */
    {0x201C, 0x22, 0x00, 0x00, 0x00},  /* ‚Äú to " */
    {0x201D, 0x22, 0x00, 0x00, 0x00},  /* ‚Äù to " */
    {0x201E, 0x22, 0x00, 0x00, 0x00},  /* ‚Äû to " */
    {0x201F, 0x22, 0x00, 0x00, 0x00},  /* ‚Äü to " */
    {0x2026, 0x2E, 0x2E, 0x2E, 0x00},  /* ‚Ä¶ to ... */
    {0x2039, 0x27, 0x00, 0x00, 0x00},  /* ‚Äπ to ' */
    {0x203A, 0x27, 0x00, 0x00, 0x00},  /* ‚Ä∫ to ' */
    {0x203C, 0x21, 0x21, 0x00, 0x00},  /* ‚Äº to !! */
    {0x2047, 0x3F, 0x3F, 0x00, 0x00},  /* ‚Åá to ?? */
    {0x2048, 0x3F, 0x21, 0x00, 0x00},  /* ‚Åà to ?! */
    {0x2049, 0x21, 0x3F, 0x00, 0x00},  /* ‚Åâ to !? */
    {0x204E, 0x2A, 0x00, 0x00, 0x00},  /* ‚Åé to * */
    {0x2E42, 0x22, 0x00, 0x00, 0x00},  /* ‚πÇ to " */
    {0xA728, 0x54, 0x5A, 0x00, 0x00},  /* Íú® to TZ */
    {0xA729, 0x74, 0x7A, 0x00, 0x00},  /* Íú© to tz */
    {0xA734, 0x41, 0x4F, 0x00, 0x00},  /* Íú¥ to AO */
    {0xA735, 0x61, 0x6F, 0x00, 0x00},  /* Íúµ to ao */
    {0xA736, 0x41, 0x55, 0x00, 0x00},  /* Íú∂ to AU */
    {0xA737, 0x61, 0x75, 0x00, 0x00},  /* Íú∑ to au */
    {0xA738, 0x41, 0x56, 0x00, 0x00},  /* Íú∏ to AV */
    {0xA739, 0x61, 0x76, 0x00, 0x00},  /* Íúπ to av */
    {0xA73A, 0x41, 0x56, 0x00, 0x00},  /* Íú∫ to AV */
    {0xA73B, 0x61, 0x76, 0x00, 0x00},  /* Íúª to av */
    {0xA73C, 0x41, 0x59, 0x00, 0x00},  /* Íúº to AY */
    {0xA73D, 0x61, 0x79, 0x00, 0x00},  /* ÍúΩ to ay */
    {0xA74E, 0x4F, 0x4F, 0x00, 0x00},  /* Íùé to OO */
    {0xA74F, 0x6F, 0x6F, 0x00, 0x00},  /* Íùè to oo */
    {0xA760, 0x56, 0x59, 0x00, 0x00},  /* Íù† to VY */
    {0xA761, 0x76, 0x79, 0x00, 0x00},  /* Íù° to vy */
    {0xFB00, 0x66, 0x66, 0x00, 0x00},  /* Ô¨Ä to ff */
    {0xFB01, 0x66, 0x69, 0x00, 0x00},  /* Ô¨Å to fi */
    {0xFB02, 0x66, 0x6C, 0x00, 0x00},  /* Ô¨Ç to fl */
    {0xFB03, 0x66, 0x66, 0x69, 0x00},  /* Ô¨É to ffi */
    {0xFB04, 0x66, 0x66, 0x6C, 0x00},  /* Ô¨Ñ to ffl */
    {0xFB05, 0x73, 0x74, 0x00, 0x00},  /* Ô¨Ö to st */
    {0xFB06, 0x73, 0x74, 0x00, 0x00},  /* Ô¨Ü to st */
    {0x1F670, 0x65, 0x74, 0x00, 0x00}, /* üô∞ to et */
};

static const Transliteration *
spellfixFindTranslit(UChar32 c __attribute__((unused)), int *pxTop) {
  *pxTop = (sizeof(translit) / sizeof(translit[0])) - 1;
  return translit;
}

/*
** Convert the input string from UTF-16 into pure ASCII by converting
** all non-ASCII characters to some combination of characters in the
** ASCII subset.
**
** The returned string might contain more characters than the input.
**
** Space to hold the returned string comes from sqlite3_malloc() and
** should be freed by the caller.
*/
static unsigned char *transliterate(const UChar *zIn, sqlite3_uint64 nIn,
                                    sqlite3_uint64 *pOut) {
  UErrorCode status = U_ZERO_ERROR;
  const UNormalizer2 *nfc = unorm2_getNFCInstance(&status);
  if (U_FAILURE(status)) {
    return NULL;
  }
  const UNormalizer2 *nfkd = unorm2_getNFKDInstance(&status);
  if (U_FAILURE(status)) {
    return NULL;
  }

  // First normalize string to NFC */
  UChar *zNorm = NULL;
  sqlite3_uint64 nNorm = nIn;
  _Bool norm_allocated = 0;

  if (unorm2_quickCheck(nfc, zIn, nIn / 2, &status) == UNORM_YES &&
      U_SUCCESS(status)) {
    zNorm = (UChar *)zIn;
  } else {
    for (int cnt = 0; cnt < 2; cnt += 1) {
      UChar *zNew = sqlite3_realloc64(zNorm, nNorm);
      if (!zNew) {
        return NULL;
      }
      norm_allocated = 1;
      zNorm = zNew;
      status = U_ZERO_ERROR;
      nNorm = (sqlite3_uint64)2 *
              unorm2_normalize(nfc, zIn, nIn / 2, zNorm, nNorm / 2, &status);
      if (U_SUCCESS(status)) {
        break;
      } else if (status == U_BUFFER_OVERFLOW_ERROR) {
        assert(cnt == 0);
        continue;
      } else {
        sqlite3_free(zNorm);
        return NULL;
      }
    }
  }

  // Allocate 4 bytes for each code unit in the source.
  unsigned char *zOut = sqlite3_malloc64(nNorm * 2 + 1);
  if (zOut == 0) {
    if (norm_allocated) {
      sqlite3_free(zNorm);
    }
    return NULL;
  }

  sqlite3_uint64 nOut = 0;
  sqlite3_uint64 off = 0;
  nNorm /= 2;

  while (off < nNorm) {
    UChar32 c;
    U16_NEXT(zNorm, off, nNorm, c);
    if (c <= 127) {
      zOut[nOut++] = (unsigned char)c;
    } else if (u_charType(c) == U_NON_SPACING_MARK) {
      continue;
    } else if (u_getIntPropertyValue(c, UCHAR_NUMERIC_TYPE) == U_NT_DECIMAL) {
      zOut[nOut++] = u_charDigitValue(c) + '0';
    } else {
      int xTop, xBtm;
      const Transliteration *tbl = spellfixFindTranslit(c, &xTop);
      xBtm = 0;
      while (xTop >= xBtm) {
        int x = (xTop + xBtm) / 2;
        if (tbl[x].cFrom == c) {
          zOut[nOut++] = tbl[x].cTo0;
          if (tbl[x].cTo1) {
            zOut[nOut++] = tbl[x].cTo1;
            if (tbl[x].cTo2) {
              zOut[nOut++] = tbl[x].cTo2;
              if (tbl[x].cTo3) {
                zOut[nOut++] = tbl[x].cTo3;
              }
            }
          }
          c = 0;
          break;
        } else if (tbl[x].cFrom > c) {
          xTop = x - 1;
        } else {
          xBtm = x + 1;
        }
      }
      if (c) {
        UChar decomposed[128];
        status = U_ZERO_ERROR;
        int len = unorm2_getDecomposition(nfkd, c, decomposed,
                                          sizeof decomposed, &status);
        if (U_SUCCESS(status)) {
          int n = 0;
          while (len-- > 0 && decomposed[n] <= 127 && n < 4) {
            zOut[nOut++] = decomposed[n++];
          }
          if (n == 0) {
            zOut[nOut++] = '?';
          }
        } else {
          zOut[nOut++] = '?';
        }
      }
    }
  }
  zOut[nOut] = 0;
  if (pOut) {
    *pOut = nOut;
  }
  if (norm_allocated) {
    sqlite3_free(zNorm);
  }
  return zOut;
}

/*
**    stripaccents(X)
**
** Convert a string that contains non-ASCII characters into
** pure ASCII.
*/
void icuStripAccentsFunc(sqlite3_context *context,
                         int argc __attribute__((unused)),
                         sqlite3_value **argv) {
  const UChar *zIn = sqlite3_value_text16(argv[0]);
  int nIn = sqlite3_value_bytes16(argv[0]);
  sqlite3_uint64 nOut;
  unsigned char *zOut = transliterate(zIn, nIn, &nOut);
  if (zOut == 0) {
    sqlite3_result_error_nomem(context);
  } else {
    sqlite3_result_text64(context, (char *)zOut, nOut, sqlite3_free,
                          SQLITE_UTF8);
  }
}
